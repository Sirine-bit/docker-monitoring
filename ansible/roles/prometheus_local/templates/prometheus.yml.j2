global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: '{{ deployment_env }}-{{ service_type }}'
    instance: '{{ inventory_hostname }}'
    region: 'local'
    environment: '{{ deployment_env }}'

scrape_configs:
  # Auto-découverte des conteneurs Docker
  - job_name: 'docker-containers'
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: label
            values: ["monitored=true"]
    
    relabel_configs:
      # Garder seulement les conteneurs avec label monitored=true
      - source_labels: [__meta_docker_container_label_monitored]
        regex: 'true'
        action: keep
      
      # Utiliser le nom du conteneur comme instance
      - source_labels: [__meta_docker_container_name]
        target_label: container_name
      
      # Ajouter le type de service
      - source_labels: [__meta_docker_container_label_service_type]
        target_label: service_type
        replacement: '{{ service_type }}'
      
      # Port mapping dynamique
      - source_labels: [__meta_docker_port_private]
        target_label: __address__
        regex: '(\d+)'
        replacement: 'localhost:${1}'

  # Node exporter local
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['localhost:9100']
        labels:
          instance_type: '{{ service_type }}'
          environment: '{{ deployment_env }}'

  # cAdvisor pour les métriques Docker
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['localhost:8080']
        labels:
          instance_type: 'docker-metrics'
          environment: '{{ deployment_env }}'

  # Métriques applicatives spécifiques selon le type de service
  {% if service_type == 'web' %}
  - job_name: 'nginx-exporter'
    static_configs:
      - targets: ['localhost:9113']
        labels:
          service_type: 'nginx'
  {% endif %}

  {% if service_type == 'database' %}
  - job_name: 'postgres-exporter'
    static_configs:
      - targets: ['localhost:9187']
        labels:
          service_type: 'postgresql'
  {% endif %}