---
groups:
  - name: federation.rules
    rules:
      # Alertes spécifiques à la fédération
      - alert: FederatedInstanceDown
        expr: up{job=~"federation-.*"} == 0
        for: 2m
        labels:
          severity: critical
          component: federation
        annotations:
          summary: "Federated Prometheus instance {{ '{{ $labels.federated_from }}' }} is down"
          description: "The Prometheus instance on {{ '{{ $labels.federated_from }}' }} has been down for more than 2 minutes. Federation data collection is interrupted."

      - alert: FederationScrapeFailure
        expr: up{job=~"federation-.*"} == 0
        for: 5m
        labels:
          severity: warning
          component: federation
        annotations:
          summary: "Federation scrape failing for {{ '{{ $labels.federated_from }}' }}"
          description: "Cannot scrape metrics from {{ '{{ $labels.federated_from }}' }} for more than 5 minutes."

  - name: cross_environment.rules
    rules:
      # Alertes comparatives entre environnements
      - alert: ProductionHighCPUUsage
        expr: |
          (
            100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle",environment="production"}[5m])) * 100)
          ) > {{ alert_thresholds.cpu | default(80) }}
        for: 3m
        labels:
          severity: warning
          environment: production
        annotations:
          summary: "High CPU usage in production on {{ '{{ $labels.instance }}' }}"
          description: "CPU usage is {{ '{{ $value | humanize }}' }}% on {{ '{{ $labels.instance }}' }} in production environment."

      - alert: EnvironmentMemoryUsage
        expr: |
          (
            (node_memory_MemTotal_bytes{environment=~"production|staging"} - node_memory_MemAvailable_bytes{environment=~"production|staging"}) 
            / node_memory_MemTotal_bytes{environment=~"production|staging"} * 100
          ) > 90
        for: 3m
        labels:
          severity: critical
        annotations:
          summary: "Critical memory usage in {{ '{{ $labels.environment }}' }} on {{ '{{ $labels.instance }}' }}"
          description: "Memory usage is above 90% on {{ '{{ $labels.instance }}' }} in {{ '{{ $labels.environment }}' }} environment."

  - name: service_health.rules
    rules:
      # Alertes pour les services par type
      - alert: WebServerDown
        expr: up{service_type="web"} == 0
        for: 1m
        labels:
          severity: critical
          service: webserver
        annotations:
          summary: "Web server down on {{ '{{ $labels.federated_from }}' }}"
          description: "Web server on {{ '{{ $labels.federated_from }}' }} has been down for more than 1 minute."

      - alert: DatabaseConnectionIssue
        expr: up{service_type="database"} == 0
        for: 30s
        labels:
          severity: critical
          service: database
        annotations:
          summary: "Database connection issue on {{ '{{ $labels.federated_from }}' }}"
          description: "Cannot connect to database on {{ '{{ $labels.federated_from }}' }} for more than 30 seconds."

      - alert: ProxyServerDown
        expr: up{service_type="proxy"} == 0
        for: 1m
        labels:
          severity: critical
          service: proxy
        annotations:
          summary: "Proxy server down on {{ '{{ $labels.federated_from }}' }}"
          description: "Proxy server on {{ '{{ $labels.federated_from }}' }} is not responding."