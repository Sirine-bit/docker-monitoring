---
- name: Update main prometheus config for federation
  template:
    src: prometheus-federation.yml.j2
    dest: "{{ project_dir }}/prometheus.yml"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'
    backup: yes
  notify: restart prometheus

- name: Generate federation alert rules
  template:
    src: federation_alert_rules.yml.j2
    dest: "{{ project_dir }}/federation_alert_rules.yml"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'
  notify: restart prometheus

- name: Wait for prometheus restart
  wait_for:
    host: "{{ ansible_host if ansible_host != 'localhost' else '127.0.0.1' }}"
    port: "{{ monitoring.prometheus.port }}"
    delay: 10
    timeout: 60

- name: Verify federation targets
  uri:
    url: "http://{{ ansible_host if ansible_host != 'localhost' else '127.0.0.1' }}:{{ monitoring.prometheus.port }}/api/v1/targets"
    method: GET
    timeout: 30
  register: federation_targets
  retries: 3
  delay: 10
  ignore_errors: yes

- name: Display federation status
  debug:
    msg: |
      ğŸ”— Federation Configuration: {{ 'SUCCESS âœ…' if federation_targets is succeeded else 'FAILED âŒ' }}
      ğŸ“Š Total Targets: {{ federation_targets.json.data.activeTargets | length + federation_targets.json.data.droppedTargets | length if federation_targets is succeeded else 'N/A' }}
      âœ… Active Targets: {{ federation_targets.json.data.activeTargets | length if federation_targets is succeeded else 'N/A' }}
      âŒ Dropped Targets: {{ federation_targets.json.data.droppedTargets | length if federation_targets is succeeded else 'N/A' }}
